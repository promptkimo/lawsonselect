<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lawson Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { background: #f8f9fa; font-family: sans-serif; padding-bottom: 80px; }
        .product-card { background: white; border-radius: 10px; padding: 10px; margin-bottom: 10px; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .product-thumb { width: 70px; height: 70px; background: #eee; border-radius: 5px; margin-right: 15px; background-size: cover; background-position: center; }
        .btn-add { width: 35px; height: 35px; border-radius: 50%; background: #0d6efd; color: white; border: none; display: flex; align-items: center; justify-content: center; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); color: white; display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 9999; }
        .hidden { display: none !important; }
        
        /* 購物車滑出層 */
        .cart-overlay { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-radius: 20px 20px 0 0; transform: translateY(100%); transition: transform 0.3s; z-index: 5000; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; max-height: 80vh; }
        .cart-overlay.active { transform: translateY(0); }
        .cart-header { padding: 15px; border-bottom: 1px solid #eee; font-weight: bold; display: flex; justify-content: space-between; }
        .cart-body { overflow-y: auto; padding: 15px; flex: 1; }
        .cart-footer { padding: 15px; border-top: 1px solid #eee; }
        
        .cart-fab { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: #0d6efd; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 4px 10px rgba(13,110,253,0.4); z-index: 1000; cursor: pointer; }
        .cart-badge { position: absolute; top: -5px; right: -5px; background: #dc3545; color: white; border-radius: 50%; padding: 4px 8px; font-size: 0.8rem; font-weight: bold; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner-border mb-3"></div>
    <div id="loading-text">連線中...</div>
</div>

<div class="container mt-3">
    <h4 class="fw-bold mb-3">Lawson Shop</h4>
    <div id="category-btn-container" class="d-flex gap-2 overflow-auto mb-3 pb-2"></div>
    <div id="product-list"></div>
</div>

<div id="cart-fab" class="cart-fab" onclick="toggleCart()">
    <i class="bi bi-cart-fill"></i>
    <span id="cart-count" class="cart-badge hidden">0</span>
</div>

<div id="cart-overlay" class="cart-overlay">
    <div class="cart-header">
        <span>購物車</span>
        <button class="btn-close" onclick="toggleCart()"></button>
    </div>
    <div class="cart-body" id="cart-items"></div>
    <div class="cart-footer">
        <div class="d-flex justify-content-between mb-3">
            <span class="h5">總計</span>
            <span class="h5 text-danger fw-bold" id="cart-total">$0</span>
        </div>
        <button class="btn btn-primary w-100 py-2 fw-bold" onclick="alert('送出訂單功能請搭配完整後端')">確認下單</button>
    </div>
</div>

<script>
    // ★ 請確認這是您剛剛部署的新網址 ★
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzr3WEQe8DB5aBaYtZ9mJcoaG7_OOxFQtpEaW4dJHiI_foNME7cEWIwp6f4it8cZABTPA/exec";
    
    let products = [];
    let cart = [];

    window.onload = function() {
        fetchProducts();
    };

    async function fetchProducts() {
        try {
            const res = await fetch(GAS_API_URL, {
                method: "POST",
                body: JSON.stringify({ action: "getProducts" }),
                headers: { "Content-Type": "text/plain;charset=utf-8" }
            });
            const text = await res.text();
            
            // ★★★ 數據顯影劑：直接看後台回傳什麼 ★★★
            console.log("後台回傳:", text); 

            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                alert("❌ 資料錯誤 (非JSON):\n" + text);
                return;
            }

            if (data.status === 'success') {
                if (data.products && Array.isArray(data.products)) {
                    products = data.products;
                    if(products.length === 0) alert("⚠️ 連線成功，但 Google Sheet 裡沒資料！");
                    renderProducts();
                    document.getElementById('loading-overlay').classList.add('hidden');
                } else {
                    // 這就是您遇到的狀況，這裡會把收到的內容印出來
                    alert("⚠️ 結構異常！後台回傳了 success，但缺少 products 欄位。\n\n回傳內容：\n" + JSON.stringify(data, null, 2) + "\n\n請務必去 GAS 按「部署」->「建立新版本」！");
                }
            } else {
                alert("❌ 後台錯誤: " + data.message);
            }
        } catch (e) {
            alert("連線失敗: " + e);
        }
    }

    function renderProducts() {
        const list = document.getElementById('product-list');
        list.innerHTML = products.map((p, idx) => `
            <div class="product-card">
                <div class="product-thumb" style="background-image: url('${p.img||''}'); background-color: #eee;"></div>
                <div class="flex-grow-1">
                    <div class="fw-bold">${p.name}</div>
                    <div class="text-danger fw-bold">$${p.price}</div>
                    <small class="text-muted">庫存: ${p.stock}</small>
                </div>
                <button class="btn-add" onclick="addToCart(${idx})">+</button>
            </div>
        `).join('');
    }

    function addToCart(idx) {
        const p = products[idx];
        const item = cart.find(x => x.id === p.id);
        if(item) item.count++; else cart.push({...p, count:1});
        updateCart();
    }

    function updateCart() {
        document.getElementById('cart-count').innerText = cart.reduce((a,b)=>a+b.count,0);
        document.getElementById('cart-count').classList.remove('hidden');
        
        let total = 0;
        document.getElementById('cart-items').innerHTML = cart.map(i => {
            total += i.price * i.count;
            return `<div class="d-flex justify-content-between mb-2"><span>${i.name} x ${i.count}</span><span>$${i.price*i.count}</span></div>`;
        }).join('');
        document.getElementById('cart-total').innerText = "$" + total;
    }

    function toggleCart() {
        document.getElementById('cart-overlay').classList.toggle('active');
    }
</script>
</body>
</html>
