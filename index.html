<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lawson Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    
    <style>
        :root { --primary-color: #0d6efd; --status-ready: #198754; --status-wait: #ffc107; }
        body { background-color: #f8f9fa; font-family: -apple-system, sans-serif; padding-bottom: 90px; }
        
        .header-bar { background-color: white; padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; margin-right: 8px; object-fit: cover; background: #eee; }
        
        /* 商品卡片 */
        .product-card { background: white; border-radius: 12px; padding: 12px; display: flex; align-items: center; margin-bottom: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); border: 1px solid #f0f0f0; }
        .product-thumb { width: 70px; height: 70px; background-color: #f8f9fa; border-radius: 8px; margin-right: 15px; background-size: cover; background-position: center; flex-shrink: 0; }
        .btn-add { width: 32px; height: 32px; border-radius: 50%; border: none; background: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; }
        
        /* 底部導航 */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-around; padding: 10px 0; z-index: 900; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-item { text-align: center; color: #999; font-size: 0.8rem; text-decoration: none; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--primary-color); font-weight: bold; }
        .nav-icon { font-size: 1.4rem; display: block; margin-bottom: 2px; }
        
        /* 訂單歷史卡片 */
        .order-history-card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .status-badge { font-size: 0.8rem; padding: 4px 8px; border-radius: 20px; color: white; background: #6c757d; float: right; }
        .status-preparing { background: #ffc107; color: #000; border-left-color: #ffc107; } /* 準備中 */
        .status-done { background: #198754; border-left-color: #198754; } /* 完成 */

        /* 歡迎/登入畫面 */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; transition: opacity 0.3s; }
        
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="login-screen">
    <h2 class="fw-bold mb-4">Lawson Shop</h2>
    <div class="d-grid gap-3 w-100" style="max-width: 300px;">
        <button class="btn btn-success btn-lg fw-bold" onclick="loginWithLINE()">
            <i class="bi bi-line me-2"></i> LINE 帳號登入
        </button>
        <button class="btn btn-outline-secondary btn-lg" onclick="loginAsGuest()">
            <i class="bi bi-person me-2"></i> 訪客直接點餐
        </button>
    </div>
    <div class="mt-4 text-muted small">
        LINE 登入可記錄歷史訂單並收到通知。<br>訪客訂單僅保留於此裝置。
    </div>
</div>

<div id="loading-overlay" class="hidden">
    <div class="spinner-border text-primary mb-3"></div>
    <div id="loading-text" class="fw-bold">處理中...</div>
</div>

<div id="main-app" class="hidden">
    <div class="header-bar d-flex justify-content-between align-items-center">
        <span class="fw-bold fs-5">Lawson Shop</span>
        <div class="d-flex align-items-center">
            <img id="u-img" class="user-avatar">
            <small id="u-name" class="fw-bold text-dark"></small>
        </div>
    </div>

    <div class="container mt-3">
        <div id="page-menu">
            <div id="product-list"></div>
        </div>

        <div id="page-orders" class="hidden">
            <h5 class="fw-bold mb-3">我的訂單記錄</h5>
            <div class="d-flex justify-content-end mb-2">
                <button class="btn btn-sm btn-outline-primary" onclick="fetchOrderHistory()">
                    <i class="bi bi-arrow-clockwise"></i> 刷新狀態
                </button>
            </div>
            <div id="order-history-list">
                <div class="text-center text-muted mt-5">載入中...</div>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('menu')" id="nav-menu">
            <i class="bi bi-shop nav-icon"></i>點餐
        </div>
        <div class="nav-item" onclick="openCartModal()">
            <div class="position-relative d-inline-block">
                <i class="bi bi-cart nav-icon"></i>
                <span id="nav-cart-badge" class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle hidden" style="width:10px;height:10px;"></span>
            </div>
            <div>購物車</div>
        </div>
        <div class="nav-item" onclick="switchPage('orders')" id="nav-orders">
            <i class="bi bi-receipt nav-icon"></i>訂單狀態
        </div>
    </div>
</div>

<div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold">購物車</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="cart-items"></div>
                <hr>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <span class="h5 m-0 text-muted">總計</span>
                    <span class="h3 m-0 text-danger fw-bold" id="cart-total">$0</span>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button class="btn btn-primary w-100 fw-bold py-3 fs-5" onclick="submitOrder()">
                    確認下單
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ================= 設定區 =================
    const LIFF_ID = "2009014517-qshUmlAc"; 
    // ★ 請填入新的部署網址 ★
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzr3WEQe8DB5aBaYtZ9mJcoaG7_OOxFQtpEaW4dJHiI_foNME7cEWIwp6f4it8cZABTPA/exec"; 
    // =========================================

    let currentUser = { id: "", name: "", type: "" }; // user or guest
    let cart = [];
    
    // 商品資料 (前台定死，若要動態需改為從 GAS 讀取)
    const products = [
        { id: 1, name: "招牌原味鬆餅", price: 50, img: "" },
        { id: 2, name: "黑糖珍珠鮮奶", price: 65, img: "" },
        { id: 3, name: "特製牛肉麵", price: 150, img: "" },
        { id: 4, name: "炸雞排", price: 80, img: "" }
    ];

    window.onload = async () => {
        // 先初始化 LIFF，判斷是否已登入
        try {
            await liff.init({ liffId: LIFF_ID });
            if (liff.isLoggedIn()) {
                // 如果已經登入過，直接進入
                const profile = await liff.getProfile();
                setCurrentUser(profile.userId, profile.displayName, "line", profile.pictureUrl);
                showMainApp();
            } else {
                // 沒登入，顯示選擇畫面 (Login Screen)
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        } catch (err) {
            console.error(err);
            // LIFF 失敗時，強制顯示選擇畫面
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        renderProducts();
    };

    // --- 登入邏輯 ---
    function loginWithLINE() {
        if (!liff.isLoggedIn()) {
            liff.login();
        }
    }

    function loginAsGuest() {
        // 產生或讀取 Guest ID
        let guestId = localStorage.getItem("pos_guest_id");
        if (!guestId) {
            guestId = "G-" + new Date().getTime().toString().slice(-6); // 簡易 Guest ID
            localStorage.setItem("pos_guest_id", guestId);
        }
        setCurrentUser(guestId, "訪客 " + guestId.slice(-4), "guest", null);
        showMainApp();
    }

    function setCurrentUser(id, name, type, pic) {
        currentUser = { id, name, type };
        document.getElementById('u-name').innerText = name;
        document.getElementById('u-img').src = pic || "https://via.placeholder.com/32/ccc/fff?text=" + name.charAt(0);
    }

    function showMainApp() {
        document.getElementById('login-screen').style.opacity = 0;
        setTimeout(() => {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
        }, 300);
    }

    // --- 頁面切換 ---
    function switchPage(pageId) {
        // UI 切換
        document.getElementById('page-menu').classList.add('hidden');
        document.getElementById('page-orders').classList.add('hidden');
        document.getElementById('nav-menu').classList.remove('active');
        document.getElementById('nav-orders').classList.remove('active');

        document.getElementById('page-' + pageId).classList.remove('hidden');
        document.getElementById('nav-' + pageId).classList.add('active');

        if (pageId === 'orders') {
            fetchOrderHistory(); // 切換到訂單頁時自動刷新
        }
    }

    // --- 商品與購物車 ---
    function renderProducts() {
        const list = document.getElementById('product-list');
        list.innerHTML = products.map(p => `
            <div class="product-card">
                <div class="product-thumb" style="background-image:url('${p.img}')"></div>
                <div class="product-info">
                    <div class="fw-bold fs-5">${p.name}</div>
                    <div class="price-tag">$${p.price}</div>
                </div>
                <button class="btn-add" onclick="addToCart(${p.id})"><i class="bi bi-plus"></i></button>
            </div>
        `).join('');
    }

    function addToCart(id) {
        const p = products.find(x => x.id === id);
        const item = cart.find(x => x.id === id);
        if(item) item.count++; else cart.push({...p, count: 1});
        updateCartUI();
        if(navigator.vibrate) navigator.vibrate(30);
    }

    function updateCartUI() {
        const count = cart.reduce((a,b)=>a+b.count,0);
        const badge = document.getElementById('nav-cart-badge');
        if(count > 0) {
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }

    function openCartModal() {
        renderCartItems();
        new bootstrap.Modal(document.getElementById('cartModal')).show();
    }

    function renderCartItems() {
        const container = document.getElementById('cart-items');
        let total = 0;
        if(cart.length === 0) {
            container.innerHTML = `<div class="text-center text-muted py-4">購物車空空的</div>`;
            document.getElementById('cart-total').innerText = "$0";
            return;
        }
        container.innerHTML = cart.map((item, index) => {
            const subtotal = item.price * item.count;
            total += subtotal;
            return `
            <div class="d-flex align-items-center mb-3 border-bottom pb-2" style="padding: 10px 0;">
                <div style="flex-grow: 1;">
                    <div class="fw-bold">${item.name}</div>
                    <small class="text-muted">$${item.price}</small>
                </div>
                <div class="d-flex align-items-center">
                    <button class="btn btn-sm btn-outline-secondary rounded-circle" style="width:30px;height:30px" onclick="changeCartQty(${index}, -1)">-</button>
                    <span class="mx-2 fw-bold">${item.count}</span>
                    <button class="btn btn-sm btn-outline-secondary rounded-circle" style="width:30px;height:30px" onclick="changeCartQty(${index}, 1)">+</button>
                </div>
            </div>`;
        }).join('');
        document.getElementById('cart-total').innerText = "$" + total;
    }

    function changeCartQty(idx, delta) {
        cart[idx].count += delta;
        if(cart[idx].count <= 0) cart.splice(idx, 1);
        renderCartItems();
        updateCartUI();
    }

    // --- 送出訂單 (API) ---
    function submitOrder() {
        if(cart.length === 0) return alert("請先選購商品");
        
        document.getElementById('loading-text').innerText = "訂單傳送中...";
        document.getElementById('loading-overlay').classList.remove('hidden');
        bootstrap.Modal.getInstance(document.getElementById('cartModal')).hide();

        const payload = {
            action: "submit", // 告訴後端這是送出訂單
            userId: currentUser.id,
            displayName: currentUser.name,
            cart: cart,
            total: cart.reduce((a,b)=>a+(b.price*b.count), 0)
        };

        fetch(GAS_API_URL, {
            method: "POST",
            body: JSON.stringify(payload),
            headers: { "Content-Type": "text/plain;charset=utf-8" }
        })
        .then(res => res.json())
        .then(data => {
            document.getElementById('loading-overlay').classList.add('hidden');
            if(data.status === 'success') {
                alert("✅ 下單成功！\n請至「訂單狀態」查看進度。");
                cart = [];
                updateCartUI();
                switchPage('orders'); // 自動跳轉到訂單頁
            } else {
                alert("❌ 錯誤: " + data.message);
            }
        })
        .catch(err => {
            document.getElementById('loading-overlay').classList.add('hidden');
            alert("連線失敗，請檢查網路");
        });
    }

    // --- 查詢訂單歷史 (API) ---
    function fetchOrderHistory() {
        const container = document.getElementById('order-history-list');
        container.innerHTML = '<div class="text-center mt-4"><div class="spinner-border text-secondary"></div></div>';

        const payload = {
            action: "getHistory",
            userId: currentUser.id
        };

        fetch(GAS_API_URL, {
            method: "POST",
            body: JSON.stringify(payload),
            headers: { "Content-Type": "text/plain;charset=utf-8" }
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                renderOrderHistory(data.orders);
            } else {
                container.innerHTML = '<div class="text-center text-danger">讀取失敗</div>';
            }
        })
        .catch(err => {
            container.innerHTML = '<div class="text-center text-danger">連線錯誤</div>';
        });
    }

    function renderOrderHistory(orders) {
        const container = document.getElementById('order-history-list');
        if(!orders || orders.length === 0) {
            container.innerHTML = '<div class="text-center text-muted mt-5">目前沒有訂單記錄</div>';
            return;
        }

        container.innerHTML = orders.map(order => {
            // 處理狀態顏色
            let statusClass = "bg-secondary";
            if(order.status.includes("準備")) statusClass = "status-preparing";
            if(order.status.includes("完成") || order.status.includes("取餐")) statusClass = "status-done";

            // 處理內容顯示
            let itemsHtml = order.cart.map(i => `<div>${i.name} x${i.count}</div>`).join('');

            return `
            <div class="order-history-card" style="border-left-color: ${statusClass === 'status-preparing' ? '#ffc107' : (statusClass === 'status-done' ? '#198754' : '#6c757d')}">
                <div class="d-flex justify-content-between mb-2">
                    <small class="text-muted">${order.time}</small>
                    <span class="status-badge ${statusClass}">${order.status}</span>
                </div>
                <div class="mb-2 text-dark small">
                    ${itemsHtml}
                </div>
                <div class="text-end fw-bold">
                    總計 $${order.total}
                </div>
            </div>`;
        }).join('');
    }
</script>
</body>
</html>
